#!/usr/bin/env bash

# --- Sane defaults ---
# append to the history file, don't overwrite it
shopt -s histappend
# Don't put duplicate lines or lines starting with space in the history.
# See bash(1) for more options
export HISTCONTROL=ignoreboth
# for setting history length see HISTSIZE and HISTFILESIZE in bash(1)
export HISTSIZE=10000
export HISTFILESIZE=2000000
# Only show the last 3 directories
export PROMPT_DIRTRIM=3

# --- Set up paths ---
# Base paths
export PATH=~/.local/bin:$PATH
# Android studio stuff
if [ "$(uname)" == "Darwin" ]; then
    export ANDROID_HOME=~/Library/Android/sdk
    export PATH=~/Library/Android/sdk/platform-tools:$PATH
elif [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
    export ANDROID_HOME=~/Android/Sdk
    export PATH=$PATH:$ANDROID_HOME/tools
    export PATH=$PATH:$ANDROID_HOME/platform-tools
fi
# Emacs bootloader
export PATH=~/.emacs.default/bin:$PATH
# JS
export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"

# --- Load other shell scripts ---
# Autojump
# - Linux
[[ -s "${HOME}/.autojump/etc/profile.d/autojump.sh" ]] && source "${HOME}/.autojump/etc/profile.d/autojump.sh"
# - Mac
[ -f /opt/homebrew/etc/profile.d/autojump.sh ] && . /opt/homebrew/etc/profile.d/autojump.sh
# Keychain
# Don't have to enter passphrases all the time. See https://stackoverflow.com/a/42165501
type keychain >&/dev/null && keychain -q --agents ssh >&/dev/null
[ -f "${HOME}/.keychain/$HOSTNAME-sh" ] && source "${HOME}/.keychain/$HOSTNAME-sh"
# JS
export NVS_HOME="$HOME/.nvs"
[ -s "${NVS_HOME}/nvs.sh" ] && . "${NVS_HOME}/nvs.sh" > /dev/null

# --- Emacs shell-mode setup ---
if [[ $INSIDE_EMACS =~ ^.*comint ]]; then
    ps1() {
      # Borrowed from
      PS1_INNER='$(echo -n "${PWD/#$HOME/~}" | awk -F "/" '"'"'{
                  if (length($0) > 14) { if (NF>4) print $1 "/" $2 "/.../" $(NF-1) "/" $NF;
                  else if (NF>3) print $1 "/" $2 "/.../" $NF;
                  else print $1 "/.../" $NF; }
                  else print $0;}'"'"')'
      PS1='\e[0;36m$(eval "echo ${PS1_INNER}") $ \e[m'
    }
    # Don't do the rest of what's in this script
    # to make sure shell-mode doesn't lag
    return 0;
fi;
